<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.levware.common.mappers.repo.UserSignUpMapper">


	<!-- 회원가입 작성자 강전일 -->
	<resultMap type="UserInfoVO" id="UserInfoVOMap">
		<result property="userId" column="USER_ID" />
	</resultMap>

	<!-- 회원가입 아이디 검색으로 아이디 중복(관리자 TB 포함) 조회 -->
	<select id="getUserIdList" parameterType="String" resultMap="UserInfoVOMap">
		SELECT A.USER_ID
		FROM (select USER_ID FROM TB_OLAP_USR WHERE USER_ID=#{userId}
		union all select MANAGER_ID AS USER_ID FROM TB_OLAP_MANAGER WHERE
		MANAGER_ID=#{userId}
		) A
	</select>

	<!-- 회원가입 아이디 검색으로 보조 아이디 중복 조회 -->
	<select id="getSubIdtList" parameterType="String" resultMap="UserInfoVOMap">
		SELECT SUB_ID
		FROM TB_OLAP_USR
		WHERE SUB_ID= #{subId}
	</select>

	<!-- 회원가입 데이터 인서트 -->
	<insert id="signUpInsert" parameterType="map">
		INSERT INTO TB_OLAP_USR
		(
		USER_ID
		,USER_PASSWORD
		,SUB_ID		
		,CREATE_ID
		,CREATE_DT
		,CREATE_TM
		,UPDATE_ID
		,UPDATE_DT
		,UPDATE_TM
		)
		VALUES
		(
		#{user_id}
		,#{encodePwd}
		,#{sub_id}
		,#{user_id}
		,CONVERT(char(8),getdate(),112)
		,CONVERT(char(8),getdate(),108)
		,#{user_id}
		,CONVERT(char(8),getdate(),112)
		,CONVERT(char(8),getdate(),108)
		)
		<!-- INSERT INTO TB_OLAP_USR
		(
		USER_ID
		,USER_PASSWORD
		,SUB_ID
		,AUTH_HINT
		,AUTH_HINT_ANS
		,CREATE_ID
		,CREATE_DT
		,CREATE_TM
		,UPDATE_ID
		,UPDATE_DT
		,UPDATE_TM
		)
		VALUES
		(
		#{user_id}
		,#{encodePwd}
		,#{sub_id}
		,#{auth_hint}
		,#{auth_hint_ans}
		,#{user_id}
		,CONVERT(char(8),getdate(),112)
		,CONVERT(char(8),getdate(),108)
		,#{user_id}
		,CONVERT(char(8),getdate(),112)
		,CONVERT(char(8),getdate(),108)
		) -->
	</insert>

	<!-- 회원목록 조회 -->
	<select id="getUserInfoList" parameterType="String" resultType="map">
		SELECT
		A.USER_ID
		,CONVERT(char(8), CONVERT(DATETIME, A.CREATE_DT),112) AS CREATE_DT
		,A.USER_PASSWORD
		,ISNULL(CONVERT(char(8), CONVERT(DATETIME, MAX(B.LOGIN_DATE)), 112), '접속이력 없음') AS LOGIN_DATE
		,(SELECT COUNT(*) FROM TB_OLAP_USR WHERE USER_ROLE = 'ROLE_USER' AND ENABLED =
		'1') AS USR_COUNT
		,A.RESET_PW
		FROM TB_OLAP_USR A LEFT OUTER JOIN TB_USR_LOG_HIST B ON A.USER_ID =
		B.USER_ID
		<where>
			AND A.USER_ROLE = 'ROLE_USER'
			AND A.ENABLED = '1'
			<if test='userId != "" and userId != null '>AND UPPER(A.USER_ID) LIKE '%'+UPPER(#{userId})+'%'
			</if>
		</where>
		GROUP BY A.USER_ID, A.CREATE_DT, A.USER_PASSWORD, A.RESET_PW
	</select>

	<!-- 회원목록 삭제 -->
	<update id="deleteUserList" parameterType="java.util.List">
		delete from TB_OLAP_USR
		
		WHERE USER_ID IN
		<foreach collection="list" item="item" index="index" open="("
			close=")" separator=",">
			#{item,jdbcType=VARCHAR}
		</foreach>
	</update>

	<!-- 회원 저장 목록 삭제 -->
	<delete id="deleteUserSaveList" parameterType="java.util.List">
		delete from TB_USR_SAVE_LIST
		WHERE USER_ID IN
		<foreach collection="list" item="item" index="index" open="("
			close=")" separator=",">
			#{item,jdbcType=VARCHAR}
		</foreach>
	</delete>
</mapper>